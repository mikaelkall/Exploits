description = [[
Attempts to find jolokia instances as it disclosure sensitive data and < 1.5.0 is vulnerable against RCE. We finds them by querying the URI "/jolokia".

https://www.cvedetails.com/cve/CVE-2018-1000130/
]]

---
-- @usage
--  nmap -sV --script jolokia-scan <target>
-- @output
-- PORT   STATE SERVICE REASON
-- 80/tcp open  http    syn-ack
-- |_jolokia-scan: {"request":{"type":"version"},"value":{"agent":"1.4.0","protocol":"7.2","config":{"listenForHttpService":"true","maxCollectionSize":"0","authIgnoreCerts":"false","agentId":"172.17.0.2-13-1eeb9e5c-servlet","agentType":"servlet","policyLocation":"classpath:\/jolokia-access.xml","agentContext":"\/jolokia","mimeType":"text\/plain","discoveryEnabled":"false","streaming":"true","historyMaxEntries":"10","allowDnsReverseLookup":"true","maxObjects":"0","debug":"false","serializeException":"false","detectorOptions":"{}","dispatcherClasses":"org.jolokia.jsr160.Jsr160RequestDispatcher","maxDepth":"15","authMode":"basic","canonicalNaming":"true","allowErrorDetails":"true","realm":"jolokia","includeStackTrace":"true","useRestrictorService":"false","debugMaxEntries":"100"},"info":{"product":"tomcat","vendor":"Apache","version":"9.0.8"}},"timestamp":1530815096,"status":200}
---

author = "nighter@nighter.se"
license = "Same as Nmap--See http://nmap.org/book/man-legal.html"
categories = {"exploit","vuln"}

local http = require "http"
local shortport = require "shortport"
local stdnse = require "stdnse"

portrule = shortport.http

action = function(host, port)

    local uri = "/jolokia"
    local _, status_404, resp_404 = http.identify_404(host, port)

    if status_404 == 200 then
        stdnse.print_debug(1, "%s: Web server returns ambiguous response. Jolokia return standard 404 status responses. Exiting.", SCRIPT_NAME)
        return
    end

    local resp = http.get(host, port, uri)
    if resp.status and http.page_exists(resp, resp_404, nil, uri) and resp.status == 200 then
        return string.format("%s", resp.body)
  end
end
